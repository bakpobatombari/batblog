{% extends 'base.html' %}
{% block title %}Chat Room{% endblock %}
{% block content %}
<div class="max-w-2xl mx-auto mt-10">
    <h1 class="text-2xl font-bold mb-4">Chat Room</h1>
    <div id="chat-messages" class="bg-white/80 rounded shadow p-4 h-96 overflow-y-auto mb-4">
        {% for message in messages %}
            <div class="mb-2">
                <span class="font-semibold {% if message.sender == user %}text-blue-700{% else %}text-gray-700{% endif %}">{{ message.sender.username }}</span>:
                <span>{{ message.content }}</span>
                <span class="text-xs text-gray-400 ml-2">{{ message.timestamp|date:"H:i:s" }}</span>
            </div>
        {% endfor %}
    </div>
    <form id="chat-form" class="flex gap-2">
        <input type="text" id="chat-input" class="flex-1 px-4 py-2 border rounded" placeholder="Type a message..." autocomplete="off">
        <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">Send</button>
    </form>
</div>
<script>
const roomId = {{ room.id }};
const userName = "{{ user.username }}";
const chatSocket = new WebSocket(
    'ws://' + window.location.host + '/ws/chat/' + roomId + '/'
);

chatSocket.onmessage = function(e) {
    const data = JSON.parse(e.data);
    const chatMessages = document.getElementById('chat-messages');
    const div = document.createElement('div');
    div.className = 'mb-2';
    div.innerHTML = `<span class="font-semibold ${data.sender === userName ? 'text-blue-700' : 'text-gray-700'}">${data.sender}</span>: <span>${data.message}</span> <span class="text-xs text-gray-400 ml-2">${data.timestamp}</span>`;
    chatMessages.appendChild(div);
    chatMessages.scrollTop = chatMessages.scrollHeight;
};

document.getElementById('chat-form').onsubmit = function(e) {
    e.preventDefault();
    const input = document.getElementById('chat-input');
    if (input.value.trim() !== '') {
        chatSocket.send(JSON.stringify({
            'message': input.value
        }));
        input.value = '';
    }
};
</script>
{% endblock %}
